{"ast":null,"code":"var _jsxFileName = \"/Users/peterchen/Dropbox/Hexlink/pwa-demo/src/layouts/register.tsx\",\n  _s = $RefreshSig$();\nimport React, { useState } from \"react\";\nimport CreatePassKeyCredential from \"utils/passkey/register/createPasskeyCredential\";\nimport validatePassKeyCreation from \"utils/passkey/register/validatePassKeyCreation\";\nimport { Container, SignInButton, Copy, UserName } from \"components/shared\";\nimport { useDispatch } from \"react-redux\";\nimport { addUserAccount } from \"redux-functionality/slices/userAccountsSlice\";\nimport generateRandomString from \"utils/generators/randomString\";\n\n// import { encode, decode } from 'cborg'\n\nimport { decode } from \"utils/passkey/shared/cbor\";\nimport { parseAuthData } from \"utils/passkey/shared/parseAuthData\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n// markup\nconst Register = ({\n  onRegister,\n  onReturnToSignIn\n}) => {\n  _s();\n  const dispatch = useDispatch();\n  const [login, setLogin] = useState(localStorage.getItem('login') || '');\n  const [username, setUsername] = useState(\"\");\n  // const [displayName, setDisplayName] = useState<string>(\"\");\n\n  const onUserNameChanged = ev => {\n    setUsername(ev.target.value);\n    setLogin(ev.target.value);\n  };\n\n  // const onDisplayNameChanged = (ev: React.ChangeEvent<HTMLInputElement>) => {\n  //   setDisplayName(ev.target.value);\n  // };\n\n  const createPassKey = async () => {\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    // MARK: THIS SHOULD BE DONE ON THE BACKEND\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    const userId = generateRandomString(16);\n    console.log(\"✅  Created userId : \", userId);\n    // rXfCD86r4OHTMk0j\n    const challengeBufferString = generateRandomString(16);\n    console.log(\"✅ Created challengeBufferString : \", challengeBufferString);\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    /* MARK: THIS SHOULD BE DONE IF AN ACCOUNT IS VALID \n             AND THE CHALLENGE BUFFER AND USERID SHOULD BE PASSED\n             FROM THE RETURN CALL IN THE SERVER\n    */\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    try {\n      const credential = await CreatePassKeyCredential(username.toLowerCase(), challengeBufferString, userId);\n      console.log(\"✅ Created Pass Key Credential ! \");\n      if (credential) {\n        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n        // MARK: THIS SHOULD BE DONE ON THE BACKEND\n        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n        console.log(\"✅ Credential is not null : \", credential);\n\n        // @ts-ignore\n        // var uint8View = new Uint8Array(credential.response.attestationObject);\n        const attestationObject = decode(credential.response.attestationObject);\n        console.log(\"🔥 \", attestationObject);\n        const authData = parseAuthData(attestationObject.authData);\n        console.log(decode(authData));\n        // const authData = navigator.credentials.parseAuthData(credential);\n\n        // Validate PassKey Creation\n        const challenge = validatePassKeyCreation(credential);\n        switch (challenge) {\n          case null:\n            console.log(\"❌ PassKey verification failed.\");\n            return;\n          default:\n            console.log(\"✅ PassKey verification passed with challenge : \", challenge);\n            // Save the user account data.\n            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n            // MARK: THIS SHOULD BE SAVED TO YOUR BACKEND DATABASE\n            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n            dispatch(addUserAccount({\n              userId: userId,\n              username: username,\n              displayName: username,\n              challengeBuffer: challengeBufferString,\n              challenge: challenge\n            }));\n            localStorage.setItem(`${login}_challengeBuffer`, challengeBufferString);\n            localStorage.setItem(`${login}_challenge`, challenge);\n            localStorage.setItem(`${login}_userId`, userId);\n            onRegister();\n            break;\n        }\n        // @ts-ignore\n        localStorage.setItem(`${login}_passkeyId`, credential.id);\n      } else {\n        console.log(\"❌ Credential does not exist.\");\n      }\n    } catch (error) {\n      console.log(\"❌ Error creating credential\");\n      // Session Timed Out\n      console.log(\"ERROR : \", error);\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(Container, {\n    children: [/*#__PURE__*/_jsxDEV(UserName, {\n      placeholder: \"Please enter your email\",\n      type: \"text\",\n      autoComplete: \"username webauthn\",\n      value: username,\n      onChange: onUserNameChanged\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 119,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(SignInButton, {\n      onClick: createPassKey,\n      children: \" Register\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 132,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Copy, {\n      children: \"Already have an account ?\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 133,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(SignInButton, {\n      onClick: onReturnToSignIn,\n      children: \"Sign In\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 134,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 118,\n    columnNumber: 5\n  }, this);\n};\n_s(Register, \"QVAQoIRyJ85p9BKO65gKFTsJsrA=\", false, function () {\n  return [useDispatch];\n});\n_c = Register;\nexport default Register;\nvar _c;\n$RefreshReg$(_c, \"Register\");","map":{"version":3,"names":["React","useState","CreatePassKeyCredential","validatePassKeyCreation","Container","SignInButton","Copy","UserName","useDispatch","addUserAccount","generateRandomString","decode","parseAuthData","jsxDEV","_jsxDEV","Register","onRegister","onReturnToSignIn","_s","dispatch","login","setLogin","localStorage","getItem","username","setUsername","onUserNameChanged","ev","target","value","createPassKey","userId","console","log","challengeBufferString","credential","toLowerCase","attestationObject","response","authData","challenge","displayName","challengeBuffer","setItem","id","error","children","placeholder","type","autoComplete","onChange","fileName","_jsxFileName","lineNumber","columnNumber","onClick","_c","$RefreshReg$"],"sources":["/Users/peterchen/Dropbox/Hexlink/pwa-demo/src/layouts/register.tsx"],"sourcesContent":["import React, { useState } from \"react\";\nimport CreatePassKeyCredential from \"utils/passkey/register/createPasskeyCredential\";\nimport validatePassKeyCreation from \"utils/passkey/register/validatePassKeyCreation\";\nimport { Container, SignInButton, Copy, UserName } from \"components/shared\";\nimport { useDispatch } from \"react-redux\";\nimport { addUserAccount } from \"redux-functionality/slices/userAccountsSlice\";\nimport * as base64url from \"../utils/passkey/shared/base64url-arraybuffer\";\nimport generateRandomString from \"utils/generators/randomString\";\nimport ts from \"typescript\";\nimport arrayBufferToString from \"utils/passkey/shared/arrayBufferToString\";\nimport parseClientData from \"utils/passkey/shared/parseClientData\";\n// import { encode, decode } from 'cborg'\nimport { Buffer } from 'buffer';\nimport { encode, decode } from \"utils/passkey/shared/cbor\";\nimport { parseAuthData } from \"utils/passkey/shared/parseAuthData\";\n\ninterface Props {\n  onRegister: () => void;\n  onReturnToSignIn: () => void;\n}\n\n// markup\nconst Register = ({ onRegister, onReturnToSignIn }: Props) => {\n  const dispatch = useDispatch();\n  const [login, setLogin] = useState(localStorage.getItem('login') || '');\n  const [username, setUsername] = useState<string>(\"\");\n  // const [displayName, setDisplayName] = useState<string>(\"\");\n\n  const onUserNameChanged = (ev: React.ChangeEvent<HTMLInputElement>) => {\n    setUsername(ev.target.value);\n    setLogin(ev.target.value);\n  };\n\n  // const onDisplayNameChanged = (ev: React.ChangeEvent<HTMLInputElement>) => {\n  //   setDisplayName(ev.target.value);\n  // };\n\n  const createPassKey = async () => {\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    // MARK: THIS SHOULD BE DONE ON THE BACKEND\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    const userId = generateRandomString(16);\n    console.log(\"✅  Created userId : \", userId);\n    // rXfCD86r4OHTMk0j\n    const challengeBufferString = generateRandomString(16);\n    console.log(\"✅ Created challengeBufferString : \", challengeBufferString);\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    /* MARK: THIS SHOULD BE DONE IF AN ACCOUNT IS VALID \n             AND THE CHALLENGE BUFFER AND USERID SHOULD BE PASSED\n             FROM THE RETURN CALL IN THE SERVER\n    */\n    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    try {\n      const credential = await CreatePassKeyCredential(\n        username.toLowerCase(),\n        challengeBufferString,\n        userId\n      );\n      console.log(\"✅ Created Pass Key Credential ! \");\n\n      if (credential) {\n        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n        // MARK: THIS SHOULD BE DONE ON THE BACKEND\n        // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n        console.log(\"✅ Credential is not null : \", credential);\n        \n        // @ts-ignore\n        // var uint8View = new Uint8Array(credential.response.attestationObject);\n        const attestationObject = decode(credential.response.attestationObject);\n        console.log(\"🔥 \", attestationObject);\n        const authData = parseAuthData(attestationObject.authData);\n        console.log(decode(authData));\n        // const authData = navigator.credentials.parseAuthData(credential);\n\n        // Validate PassKey Creation\n        const challenge = validatePassKeyCreation(credential);\n        switch (challenge) {\n          case null:\n            console.log(\"❌ PassKey verification failed.\");\n            return;\n          default:\n            console.log(\n              \"✅ PassKey verification passed with challenge : \",\n              challenge\n            );\n            // Save the user account data.\n            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n            // MARK: THIS SHOULD BE SAVED TO YOUR BACKEND DATABASE\n            // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n            dispatch(\n              addUserAccount({\n                userId: userId,\n                username: username,\n                displayName: username,\n                challengeBuffer: challengeBufferString,\n                challenge: challenge,\n              })\n            );\n            localStorage.setItem(`${login}_challengeBuffer`, challengeBufferString);\n            localStorage.setItem(`${login}_challenge`, challenge);\n            localStorage.setItem(`${login}_userId`, userId);\n            onRegister();\n            break;\n        }\n        // @ts-ignore\n        localStorage.setItem(`${login}_passkeyId`, credential.id);\n      } else {\n        console.log(\"❌ Credential does not exist.\");\n      }\n    } catch (error) {\n      console.log(\"❌ Error creating credential\");\n      // Session Timed Out\n      console.log(\"ERROR : \", error);\n    }\n  };\n\n  return (\n    <Container>\n      <UserName\n        placeholder={\"Please enter your email\"}\n        type={\"text\"}\n        autoComplete={\"username webauthn\"}\n        value={username}\n        onChange={onUserNameChanged}\n      />\n      {/* <UserName\n        placeholder={\"What should we call you?\"}\n        type={\"text\"}\n        value={displayName}\n        onChange={onDisplayNameChanged}\n      /> */}\n      <SignInButton onClick={createPassKey}> Register</SignInButton>\n      <Copy>Already have an account ?</Copy>\n      <SignInButton onClick={onReturnToSignIn}>Sign In</SignInButton>\n    </Container>\n  );\n};\n\nexport default Register;\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}